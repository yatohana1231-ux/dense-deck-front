# ログイン / ユーザー識別 MVP要件（確定版）

## 1. ユーザー種別
- ユーザーは **ゲスト** または **登録ユーザー** のいずれかとする。
- 登録は必須ではなく、ゲストとして参加できる。

---

## 2. ユーザーID
- システムはユーザーに **一意な userId** を付与する。
- ゲストユーザーにも userId を付与し、以後の履歴は userId に紐づく。
- **ゲストから登録ユーザーへ移行した場合も userId は変更しない**（昇格方式）。

---

## 3. ゲストセッション
- ゲストユーザーはセッションを持つ。
- セッションの有効期限は **90日固定**。
- **再訪（再ログイン / 起動）時に expires を90日に延長**する（スライディング延長）。
- ゲストの継続は **同一ブラウザで cookie 等が保持されている限り**成立する。
- cookie 削除やブラウザ変更時は、新規ゲストとして扱う。

---

## 4. ログアウト
- ログアウト機能を提供する（ゲスト / 登録ユーザーで挙動は共通）。
- ログアウトは **セッション破棄**を意味する。
- ゲストユーザーは、ログアウト後の次回アクセス時に **新規ゲストとして開始**する。

---

## 5. 登録（ゲスト → 登録）
- 登録に必要な入力は以下とする。
  - email
  - password
- 登録成功時は **ゲスト userId のまま登録ユーザーへ昇格**し、過去の履歴をすべて引き継ぐ。
- 登録完了時のセッション挙動：
  - ゲスト用セッションを破棄
  - 登録ユーザー用セッションを **新規発行**し、ログイン状態にする
- 登録時に指定した email が既に登録済みの場合：
  - 登録は失敗とする
  - ユーザーには **ログインを促す**
  - アカウント統合や履歴マージは行わない

---

## 6. username（表示名）
- username は自動的に初期値が設定される  
  （例：`Player-xxxx` など。具体的な形式は実装側で決定）
- username は **1回のみ変更可能**。
  - 登録時点で既に変更されていた場合、その時点で変更権を消費し **以後変更不可**。
- username は **一意**である。
- 制約：
  - 最大 **20文字**
  - 使用可能文字：`a-z A-Z 0-9 _ . -`
  - 日本語・全角文字・絵文字は **不可**
  - （推奨）先頭および末尾は英数字

---

## 7. パスワードリセット
- MVPにおいてパスワードリセット機能を提供する。
- 方式：**メールでリセットリンクを送信**。
- リセットリンクの仕様：
  - 有効期限：**1時間**
  - **ワンタイム**（使用後は無効）
- リセット要求時のレスポンスは、対象 email の存在有無に関わらず **同一文言**とする  
  （メールアドレスの存在判定を外部に漏らさない）。

---

## 8. ハンド履歴（MVP関連要件）
- ハンド履歴は **userId と紐づけて保存**する。
- ハンドリプレイおよび一覧表示では、**自分が参加したハンドのみ表示**する。

---

## 9. スコープ外（MVPでは実装しないが将来想定）
- アカウント統合 / マージ
- ゲストの端末間引き継ぎ
- 多言語 username / 表示名
- 2FA、デバイス認証、ログイン通知
- ルーム対戦・ハンド共有・公開アーカイブ機能
