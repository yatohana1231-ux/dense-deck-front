# Dense Deck Poker – 仕様書 ver0.2

本ディレクトリは  
**Dense Deck Poker – 4max Single Blind Mode** の  
仕様書 ver0.2 をチャプター単位で分割したものである。

ver0.2 の主眼は以下にある：

- スターティングハンド抽選を  
  「許可/不許可」から **重み付き抽選＋棄却法** へ移行
- ボード先確定方式の正式採用
- 抽選ロジックの公平性・安全性の厳密化
- MVP 実装に耐える仕様精度の確保

本仕様は ver1.0 の前段階として位置づけられる。

# 1. ゲーム概要

Dense Deck Poker は NLHE を基盤としたポーカー派生ゲームであり、  
スターティングハンドの分布を **重み付き確率分布** によって制御する。

## 特徴
- プレイ密度の向上
- 読み合いの濃縮
- 公平性の維持
- カスタマイズ可能なデッキ設計

## 基本情報
- プレイヤー人数：4max（UTG / CO / BTN / BB）
- ブラインド構造：シングルブラインド（BB のみ）

# 2. デッキ仕様（ver0.2）

本章は Dense Deck の中核仕様である  
**スターティングハンド生成ロジック** を定義する。

---

## 2.1 デッキ構成
- 通常の 52 枚デックを使用
- 物理構造は NLHE と完全一致
- ゲーム性の差異は「抽選ロジック」で表現する

---

## 2.2 ボードカードの事前確定

### 処理フロー
1. 52 枚デックをシャッフル
2. 上から 10 枚を `boardReserved` として確定
   - [0..2] フロップ
   - [3] ターン
   - [4] リバー
   - [5..9] 内部焼きカード

### 性質
- ボード分布は NLHE と完全一致
- ハンド抽選と独立

---

## 2.3 ハンドクラスと重み

### クラスキー
- 169 種類（AA, AKo, AKs, …）
- ランク降順＋ suited / offsuit 規則

### 重み
- handWeights.json により定義
- 任意の非負実数
- 0 は抽選対象外
- 正規化は内部処理で行う

---

## 2.4 コンボ列挙と複合重み
```
effectiveWeight(classKey)
= handWeight[classKey][mode] × combos(classKey)
```

- combos は物理デック上の組合せ数
- 自然な出現確率を再現するための設計

---

## 2.5 ハンド抽選方式（独立抽選＋棄却）

### 基本方針
- 全プレイヤーは **同一デックから独立抽選**
- 抽選時点では他プレイヤー・ボードを除外しない

### 手順
1. 各プレイヤーが classKey を重み付き抽選
2. 対応する combo を 1 つ選択
3. 4人分＋ボード10枚で重複チェック
4. 重複があれば全体棄却

---

## 2.6 棄却上限とフォールバック（A方式）

### 終了条件
- 経過時間 > 1.0 秒
- または棄却回数 ≥ 256

### フォールバック
1. boardReserved を除いた 42 枚から
2. 一様ランダムで 8 枚を抽選
3. UTG → BB に 2 枚ずつ配布
4. 必ず 1 回で成功

# 3. ポジション定義（4max）

1. UTG
2. CO
3. BTN
4. BB

## シングルブラインド採用理由
- Dense Deck では参加率が高い
- SB の構造的不利が過度に拡大するため

# 4. ブラインド・スタック仕様

- BB：1BB（強制）
- SB：なし
- 初期スタック：100BB
- ベット構造：ノーリミット（NLHE 準拠）

# 5. ゲームフロー（ver0.2）

1. Shuffle
2. boardReserved（10枚）確定
3. ハンド抽選（重み付き＋棄却）
4. Preflop
5. Flop → Action
6. Turn → Action
7. River → Action
8. Showdown
9. Payout

# 6. アクション仕様

## 利用可能アクション
- Fold
- Check
- Call
- Bet
- Raise
- All-in

## ストリート終了条件
1. 全員の投入額が等しい
2. 全員が 1 回以上行動済み

# 7. AI仕様（MVP）

## プリフロップ
- BTN：100% オープン
- CO：95%
- UTG：85%
- BB：広くディフェンス
- オープンサイズ：3BB
- 3bet/4bet：コール額 × 3

## ポストフロップ
- 役 or 強ドロー → ベット
- 弱ヒット / エア → チェック
- ベットには役 or ドローでコール

# 8. 勝敗判定

NLHE と完全同一：

- Royal Flush
- Straight Flush
- Four of a Kind
- Full House
- Flush
- Straight
- Trips
- Two Pair
- One Pair
- High Card

# 9. UI仕様（MVP）

- 4人座席
- ボード（5枚）
- スタック / ポット
- アクション UI
- 行動プレイヤー直上にポップアップ
- ハンド履歴表示

# 10. 将来拡張

- Super Dense / Dense / Full 切替
- HU 20BB モード
- ラボ機能
- オンライン PvP
- ハンドギャラリー
- ユーザーカスタムデッキ

# 11. ver0.2 完成条件

- 重み付き抽選が正しく動作
- 棄却法が 1 秒以内に必ず終了
- フォールバックが安全に機能
- 4max ゲームが完走可能
- AI が自然にプレイ
- ハンド履歴が保存・閲覧可能
