# Dense Deck Poker – 4max Single Blind Mode  
# **仕様書 ver0.2（重み付きデッキ抽選版）**

---

# 1. ゲーム概要

Dense Deck Poker は NLHE を基盤とし、  
スターティングハンドを **重み付き確率分布** によって抽選するポーカー派生ゲームである。

特徴：

- ゲームプレイ密度の向上  
- 調整自由度の高いハンド分布  
- 公平性と分析性の向上  
- プレイヤーに濃い判断スポットを提供  

プレイヤー人数：**4max（UTG / CO / BTN / BB）**  
ブラインド構造：**シングルブラインド（BB のみ）**

---

# 2. デッキ仕様（ver0.2）

## 2.1 デッキ構成（物理デッキ）
- 52 枚の標準トランプ  
- ランク A〜2、スート 4種  
- カードの物理構造は NLHE と同一

---

## 2.2 ボードカードの事前確定

### 2.2.1 処理フロー
1. フルデック（52 枚）をシャッフル  
2. 上から **10 枚** を `boardReserved` として確定  
   - `boardReserved[0..2]` → フロップ  
   - `boardReserved[3]` → ターン  
   - `boardReserved[4]` → リバー  
   - `boardReserved[5..9]` → 内部利用のみ（焼きカード相当）  
3. 残り 42 枚を **ハンド抽選デック** とする

### 2.2.2 目的と効果
- フロップ/ターン/リバーの分布は **NLHE と完全一致**  
- ハンド側の重み付け調整を行っても、ボード分布は歪まない  
- 公平性と確率構造の安定性が保証される

---

## 2.3 ハンドクラスと重み

### 2.3.1 クラスキー（169種類）
- 例：`AA`, `QQ`, `AKs`, `QJo`, `T9s`
- 生成ルール  
  - ランクの高い順に並べる  
  - スート一致 → `s`  
  - 不一致 → `o`  
  - ペアは `s/o` を付けない

### 2.3.2 重みテーブル（handWeights.json）
```json
{
  "AA":  { "superDense": 1.00, "dense": 1.00 },
  "AKs": { "superDense": 0.85, "dense": 1.00 },
  "QJo": { "superDense": 0.25, "dense": 0.70 },
  "72o": { "superDense": 0.00, "dense": 0.10 }
}
```
- 重みは 非負実数
- 0 → 抽選対象外（以前の「不許可」と同義）
- ゲームモードごとに異なる重みを保持
- 抽選確率は 重みの相対比で決まる

## 2.4 ハンド抽選アルゴリズム（棄却法）
### 2.4.1 全体フロー

1. boardReserved（10 枚）を確定
2. 残り 42 枚を availableCards として保持
3. 座席順（UTG → CO → BTN → BB）で
    重み付きルーレット抽選 → クラス選択 → 実カード組抽選
4. 重複・使用不可の場合は棄却し再抽選
5. 全プレイヤーへ 2 枚ずつ配り終えた時点で完了

### 2.4.2 クラス抽選（重み付きルーレット）

1. totalWeight = Σ(weight[classKey])
2. 一様乱数 u ∈ [0, totalWeight) を生成
3. 累積和で classKey を決定
4. 重み 0 のクラスは抽選対象外

### 2.4.3 クラスに対応する実カード列挙

例：AKs
- A♦K♦, A♥K♥, A♣K♣, A♠K♠
- ただし availableCards に残っている組のみ

例 ：QJo
- Q-J のスート不一致 12 種
- availableCards に存在する組だけを候補とする

候補 0 → 棄却 → クラス再抽選

### 2.4.4 実カード組の確定

1. 候補リストから均等ランダムで 1 組を選択
2. 以下の条件を満たすか確認
- 他プレイヤー holeCards と重複しない
- boardReserved と重複しない
3. OK → 2 枚確定
4. NG → 棄却 → 抽選からやり直し

### 2.4.5 棄却法の特徴

- ハンド分布のみを調整し、ボード分布を一切歪めない
- デッキの整合性（重複なし）を完全保証
- 重みを変えるだけでゲームバランスの再設計が可能

3. ポジション定義（4max）

1. UTG
2. CO
3. BTN
4. BB（唯一の強制ブラインド）
SB は存在しない。
Dense Deck では参加率が高く、SB の構造的弱さが不公平性を生むため。

# 4. ブラインド・スタック仕様

- BB：1BB
- SB：なし
- 初期スタック：100BB
- ベット方式：ノーリミット（NLHE準拠）

# 5. ゲームフロー（ver0.2）

1. フルデックをシャッフル
2. ボード予約カードを10枚確定
3. 重み付き抽選（棄却法）で全プレイヤーのハンドを決定
4. プリフロップアクション
5. フロップ公開（boardReserved[0..2]） → アクション
6. ターン公開（boardReserved[3]） → アクション
7. リバー公開（boardReserved[4]） → アクション
8. ショーダウン
9. ポット分配
10. ラウンド終了

# 6. アクション仕様

利用可能アクション：
1. Fold
2. Check
3. Call
4. Bet
5. Raise
6. All-in
ベット・レイズサイズは NLHE と同一ルール。

# 7. 勝敗判定

役階級および比較ルールは NLHE と完全一致：
- ロイヤルフラッシュ
- ストレートフラッシュ
- 4カード
- フルハウス
- フラッシュ
- ストレート
- 3カード
- 2ペア
- 1ペア
- ハイカード

# 8. AI 仕様（MVP）
## 8.1 プリフロップ
- BTN：重み > 0 のハンドは 100% オープン（3BB）
- CO：95% オープン
- UTG：85% オープン
- BB：広くディフェンス
- 3bet/4bet サイズ：相手レイズ額 × 3

## 8.2 ポストフロップ
- 役 or 強ドロー → ベット
- 弱ヒット or エア → チェック
- 相手ベットには
  - 役 or ドロー → コール
  - その他 → フォールド
- ベットサイズ：ハーフポット

# 9. UI仕様（MVP）
- 座席（4人）表示
- プレイヤースタック
- ボード（5枚）
- ポットサイズ
- アクション UI（Fold / Call / Raise / All-in）
- 行動プレイヤーの座標上にアクションポップアップを表示

# 10. 将来拡張（v2.0+）
- HU 20BB Dense Deck モード
- 複数モード（Super Dense / Dense / Full Deck）切替
- オンライン PvP
- リプレイ解析・コーチング
- 重み調整 UI（ビルダー）
- クラウド保存

# 11. 完成条件（ver0.2）
- 重み付き抽選（棄却法）が完全に動作
- ボード先確定方式が正しく実装
- ハンド重複が一切発生しない
- 4max シングルブラインドでゲームが完走可能
- ショーダウン・ポット分配の正確性
- AI が最低限自然に戦える
- ハンド履歴が参照可能