# ゲーム進行ロジック概要

本仕様書は、Dense Deck Poker における 1ハンドの進行ロジックを定義する。

## 対象モード
- 4max（UTG / CO / BTN / BB）
- シングルブラインド（BBのみ）
- ルーム制オンライン対戦（MVP、フルPvP非対応）

## 本仕様のスコープ
- ハンド開始〜決着〜次ハンド開始までの進行
- デッキ抽選・配布・アクション処理・ショーダウン
- 切断・タイムアウトを含む進行制御

## 本仕様に含まれないもの
- UI詳細
- GTOロジック
- 課金・称号・ランキング要素

# 状態モデル

## ルーム状態（Room State）
- WAITING : 着席中（ハンド未開始）
- STARTING : ハンド開始処理中
- IN_HAND : ハンド進行中
- CLOSED : ルーム解散

## ハンド状態（Hand State）
- HAND_INIT
- PREFLOP
- FLOP
- TURN
- RIVER
- SHOWDOWN
- HAND_END

## アクション状態
- ACTION_WAIT : 入力待ち
- ACTION_APPLY : アクション反映処理中

## 状態遷移の原則
- IN_HAND 中の参加・観戦は禁止
- 退出・オーナー移譲は HAND_END のみで処理

# ハンド初期化と配布

## HAND_INIT
- 着席者を確定する
- 各プレイヤー状態を初期化
  - inHand
  - hasFolded
  - isAllIn
  - committedThisStreet
  - committedThisHand
- ポット・サイドポット構造を初期化

## ボード先取り（boardReserved）
- 52枚デックをシャッフル
- 上位10枚を boardReserved として確定
  - 0–2: flop
  - 3: turn
  - 4: river
  - 5–9: 内部予約

## ホールカード配布
- 各プレイヤーに2枚配布
- 重み付き分布を使用
- 以下の場合は棄却して再抽選
  - boardReserved と重複
  - 他プレイヤーと重複
- 棄却上限到達時は falldown 扱い

# ブラインドとアクション順

## ブラインド
- BB席のみ強制ベット
- スタック不足時はオールイン

## プリフロップのアクション順
- BBの次席（UTG）から開始

## ポストフロップのアクション順
- ボタン左（UTG）から開始
- 生存プレイヤーのみ対象

# アクション共通ルール

## 可能なアクション
- fold
- check
- call
- bet
- raise
- all-in

## アクション制約
- check : 追加ベット不要時のみ
- call : 不足額を支払う（不足時はオールイン）
- bet : 当該ストリート初回のみ
- raise : ベット存在時のみ

## ストリート終了条件（streetEnd）
- 未オールインの全員が
  - 同額までコミット済み
  - 最後のアグレッサー以降、意思決定が1巡

## ハンド即終了条件
- 生存者が1人のみになった場合

---

# オールインとサイドポット

本章では、オールインが発生した場合の進行ルールおよび、
オールインに関連する「許可アクション」と状態遷移を定義する。

## オールイン状態の定義

- プレイヤーが自身の残りスタックをすべて投入した時点で、
  当該プレイヤーは **オールイン状態（isAllIn = true）** に遷移する。
- オールイン状態に遷移したプレイヤーは、
  以降のストリートにおいて **意思決定主体から除外される**。

## オールイン発生時の扱い

- オールインは bet / raise / call の結果として発生する
- オールイン発生時点で、
  プレイヤーは **「オールイン済みプレイヤー」** として扱われ、
  通常プレイヤーとは異なる進行ルールが適用される

---

## オールインに対する許可アクション

### 原則
- オールインが発生しても、
  **未オールインかつ inHand のプレイヤーはアクションを継続できる**
- ただし、以下の制約が適用される

---

### コール可能条件
- 要求額以上のスタックを保有している場合 → call
- 要求額未満の場合 → オールインコール（当該プレイヤーも isAllIn に遷移）

---

### レイズ可能条件

以下 **すべてを満たす場合のみ**、レイズを許可する：

1. プレイヤーが未オールインである
2. 対象となる bet / raise が存在する
3. 直前の bet / raise が
   - **有効なレイズとして成立している**

---

### レイズ不可条件（HU含む）

次の場合、**レイズは禁止**される：

- 相手のオールイン額が、
  - 直前の有効ベットに対して **最小レイズ未満の増加**である場合

#### 具体例（HU）
- BTN（100BB） vs BB（20BB）
- BTN bet 10BB
- BB all-in 20BB（= 実質 +10BB）

→ BB はオールイン状態に遷移  
→ このオールインは **有効なレイズを構成しない**  
→ BTN は **call または fold のみ許可**  
→ 再レイズは禁止される

※ 本制約は HU に限らず、すべての人数で適用される

---

## オールイン済みプレイヤーの扱い

- オールイン済みプレイヤーは、
  - アクション順から除外される
  - ベットラウンド終了判定の対象外となる
- ただし、
  - ポット構成
  - 勝敗判定
 には引き続き関与する

---

## 全員オールイン状態の定義（ストリート終了後判定）

全員オールイン状態とは、
**ストリートの終了が確定した時点の状態**に基づいて判定される
進行確定状態を指す。

以下をすべて満たす場合、
当該ストリート終了後に「全員オールイン状態である」と判定する：

- 当該ストリートが終了していること
  - すべての未フォールドプレイヤーについて、
    当該ストリートにおけるベット額の不一致が解消されている
    （call / check / fold が完了している）
- かつ、
  - 当該ストリート終了時点において、
    inHand = true のプレイヤーのうち、
    **次ストリート以降でベットまたはレイズを行うことが可能な
    プレイヤーが存在しない**

この条件を満たす場合、
以降のストリートでは新たなベット・レイズは発生せず、
未公開のボードカードはアクション無しで順次オープンされる。

---

### 次ストリートにおけるベット／レイズ可能性の判定

次ストリート以降において、
あるプレイヤーが「ベットまたはレイズを行うことが可能である」とは、
以下をすべて満たす場合を指す：

- 当該プレイヤーが
  - inHand = true
  - フォールド済みでない
  - isAllIn = false
- かつ、
  - 次ストリート開始時点において、
    当該プレイヤーの残りスタックが 0 より大きい
- かつ、
  - 当該プレイヤーが、
    次ストリートにおいて
    - ルール上 bet を開始する権利を持つ
    - または、他プレイヤーの bet に対して
      有効な raise を構成できる
    いずれかの条件を満たすこと

上記条件をすべて満たすプレイヤーが
**一人でも存在する場合**、
当該ストリート終了時点では
「全員オールイン状態」とは判定しない。

---

## 全員オールイン時の進行ルール

全員オールイン状態と判定された場合、
当該ハンドは通常のストリート進行とは異なる
**オールイン専用進行フロー**に移行する。

本進行は、通常ポット進行ルールとの差分として定義される。

---

### オールイン専用進行フロー

全員オールイン状態成立後、
以下の順序で処理を行う：

1. **ショーダウン**

  - ショーダウン時点で、
    inHand = true の全プレイヤーは
    ホールカードを公開状態とする
   - この時点では勝敗判定は行わない

    ※ 全員オールイン進行における SHOWDOWN は、
    通常進行における SHOWDOWN と同一の状態を指すが、
    進行順序（ボードオープンとの関係）が異なる。


2. **ボードオープン**
   - 未公開のボードカードをオープンする
   - MVP では Once（1回のみ）を採用する
   - 将来的に以下の拡張を許容する設計とする：
     - Once : ボードを1回のみオープン
     - Twice : ボードを2回オープンし、ポットを分割して解決

3. **勝敗判定**
   - オープンされた各ボードごとに、
     ポット単位で勝敗判定を行う
   - Once / Twice に応じて、
     判定対象となるボードおよびポット配分を決定する

4. **スタック移動処理**
   - 勝敗判定結果に基づき、
     各ポットのスタックをプレイヤーに配分する
   - 配分処理はすべてのボード判定完了後に行う

5. **次ハンド開始**
   - HAND_END を経て、
     次ハンドの開始処理へ遷移する

---

### 通常ストリート進行との違い

- 通常進行では、
  - 各ストリートごとにアクション → ボードオープン → 次ストリート
  を繰り返す
- 全員オールイン時の進行では、
  - アクションフェーズは一切発生しない
  - ショーダウンがボードオープンに先行する
  - ボードオープン方式（Once / Twice）が選択可能である

---

## サイドポットとの関係

- 全員オールインが成立した時点で、
  ポット構造（メイン・サイド）は確定する
- 以降の進行において、
  - ポット構造
  - eligiblePlayers
  が変更されることはない

---

## ショーダウンへの遷移

- river オープン完了後、
  即座に SHOWDOWN フェーズへ遷移する


# ボードオープン規則

## 通常進行
- 各ストリートにおいて、
  - アクション完了後に次のボードカードをオープンする
- ボードオープン後、次ストリートのアクションフェーズへ遷移する

---

## オールイン進行

- 全員オールイン状態と判定された場合でも、
  **ボードカードはストリート単位で順次オープンされる**
- フロップ → ターン → リバーの順序は通常進行と同一とする
- 各ストリートのボードオープン間には、
  **演出および視認のためのタイムラグを設ける**
- オールイン進行中は、
  - プレイヤーの入力受付
  - アクションフェーズ
  は発生しない
- すべての必要なボードカードがオープンされた後、
  勝敗判定フェーズへ遷移する

---

# ショーダウンと配分

## ショーダウン条件
- リバーの streetEnd
- または全員オールイン後のボード開放完了

## 勝者判定
- ポット単位で役判定
- 複数勝者はスプリット

## 配分
- 各ポットを eligiblePlayers にのみ分配
- スタックを更新

# HAND_END とハンド境界処理

## HAND_END
- played_at を確定
- hand_records / hand_participants を保存

## ハンド境界処理
- 退出予約者の退出確定
- オーナー退出時は以下を選択
  - オーナー移譲
  - ルーム解散

# タイムアウト・切断

## アクションタイムアウト
- check可能時 : autoCheck
- それ以外 : autoFold

## 切断処理
- heartbeat により検知
- 猶予時間内に復帰不可の場合、タイムアウト扱い
